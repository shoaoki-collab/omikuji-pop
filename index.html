<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„Åä„Åø„Åè„ÅòÔΩúPOP Edition MAXÔºàGuided UIÔºâ</title>
  <meta name="theme-color" content="#ff2d55" />
  <meta name="description" content="„Éú„Çø„É≥„ÇíÊäº„Åô„Å†„Åë„Åß„Åä„Åø„Åè„Åò„ÄÇÁõ¥ÊÑüÁöÑ„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„Ç¨„Ç§„Éâ‰ªò„ÅçPOP UI„ÅÆÂçò‰∏Ä„Éï„Ç°„Ç§„É´Web„Ç¢„Éó„É™„ÄÇ" />
  <style>
    /* =====================
       POP MAX THEME ‚Äî louder, brighter, happier, guided
       ===================== */
    :root{
      --ink:#0b1020;           /* comic outline */
      --paper:#fffaf5;         /* warm paper */
      --pop-pink:#ff2d55;
      --pop-yellow:#ffd166;
      --pop-blue:#3a86ff;
      --pop-green:#06d6a0;
      --pop-purple:#8a5cf6;
      --muted:#667085;
      --shadow-pop: 0 6px 0 var(--ink), 0 14px 24px rgba(0,0,0,.18);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Yu Gothic", "Noto Sans JP", Meiryo, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(circle at 12% -10%, rgba(255,255,255,.9) 0 35%, transparent 36%),
        radial-gradient(circle at 88% -10%, rgba(255,255,255,.85) 0 35%, transparent 36%),
        repeating-radial-gradient(circle at 20% 15%, rgba(0,0,0,.06) 0 2px, transparent 2px 8px),
        repeating-linear-gradient(135deg, #fff0 0 16px, rgba(58,134,255,.08) 16px 32px),
        linear-gradient(180deg, #fff 0%, #ffe9f0 35%, #fff4d8 70%, #fffbf2 100%);
      background-attachment: fixed;
      display:grid; place-items:center; overflow:hidden;
      animation:bg-pan 20s linear infinite alternate;
    }
    @keyframes bg-pan{to{background-position: -40px 20px, 20px -30px, 0 20px, 20px 0, 0 0}}

    .wrap{width:clamp(320px, 94vw, 900px); padding:24px}

    /* STICKER CARD */
    .card{
      position:relative; background:var(--paper);
      border:3px solid var(--ink); border-radius:var(--radius);
      box-shadow:var(--shadow-pop); padding:30px 24px 26px; isolation:isolate;
      transform:rotate(-0.4deg); transition: transform .2s ease, filter .2s ease;
    }
    .card.halo{filter:drop-shadow(0 0 0.75rem rgba(255,45,85,.6));
      animation:halo 2.4s ease-in-out infinite}
    @keyframes halo{50%{filter:drop-shadow(0 0 1.1rem rgba(255,45,85,.85)) hue-rotate(30deg)} 100%{filter:drop-shadow(0 0 0.75rem rgba(255,45,85,.6))}}

    .card:before, .card:after{content:""; position:absolute; inset:-10px; z-index:-1; border-radius:28px; filter:blur(0.5px)}
    .card:before{background:conic-gradient(from 220deg,
                      var(--pop-yellow), var(--pop-pink), var(--pop-blue), var(--pop-green), var(--pop-purple), var(--pop-yellow));
                  transform:rotate(1deg); opacity:.25}
    .card:after{background: repeating-linear-gradient(135deg, #fff0 0 12px, rgba(0,0,0,.05) 12px 18px)}
    .card:hover{transform:rotate(0deg)}

    /* DECO shapes */
    .deco{position:absolute; inset:0; pointer-events:none}
    .burst{position:absolute; width:64px; height:64px; filter:drop-shadow(0 6px 0 var(--ink));
      background: radial-gradient(circle at 50% 50%, var(--pop-yellow), var(--pop-pink));
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation:float 6s ease-in-out infinite;
    }
    .burst.b1{top:-18px; left:-18px; animation-delay:-1s}
    .burst.b2{bottom:-22px; right:-22px; background:radial-gradient(circle at 40% 40%, var(--pop-green), var(--pop-blue)); animation-delay: -.4s}
    @keyframes float{50%{transform:translateY(-6px) rotate(6deg)} 100%{transform:none}}

    h1{margin:0 0 2px; font-size:clamp(28px, 5vw, 42px); letter-spacing:.02em; line-height:1}
    .headline{
      display:inline-block; padding:6px 12px 8px; background:linear-gradient(90deg, var(--pop-pink), var(--pop-yellow));
      color:#fff; border:3px solid var(--ink); border-radius:14px; box-shadow:var(--shadow-pop);
      text-shadow:0 2px 0 rgba(0,0,0,.15);
    }
    .sub{color:var(--muted); font-size:14px; margin:10px 0 14px}

    
    .actions{display:grid; grid-template-columns: 1fr; gap:10px; margin:12px 0 10px}
    @media (min-width:640px){ .actions{grid-template-columns: 1fr auto auto} }

    button{appearance:none; border:3px solid var(--ink); background:#fff; color:var(--ink); cursor:pointer; position:relative; overflow:hidden}

    /* Primary CTA ‚Äî BIG */
    .cta{border-radius:16px; padding:16px 18px; box-shadow:var(--shadow-pop); font-weight:900; font-size:clamp(18px, 3.8vw, 22px); display:flex; align-items:center; justify-content:center; gap:10px}
    .cta .icon{font-size:1.4em}
    .cta{background: linear-gradient(180deg, var(--pop-yellow), var(--pop-pink)); color:#111; text-shadow:0 1px 0 rgba(255,255,255,.5)}
    .cta:hover{transform:translateY(-2px)}
    .cta:active{transform:translateY(1px)}

    /* Attention pulse beforeÂàùÂõû */
    .pulse{animation:pulse 1.4s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,45,85,.5)} 70%{box-shadow:0 0 0 14px rgba(255,45,85,0)} 100%{box-shadow:0 0 0 0 rgba(255,45,85,0)}}

    /* Secondary ‚Äî subtle */
    .btn-ghost{border:2px dashed var(--ink); background:#fff; color:#111; border-radius:12px; padding:10px 12px; font-weight:800; font-size:14px; opacity:.9}
    .btn-ghost[disabled]{opacity:.45; cursor:not-allowed}

    .result{margin:12px 0 0}
    .result.hidden{display:none}

    /* FORTUNE block */
    .fortune{ display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center; margin:10px 0 6px}
    .fortune .emoji{font-size: clamp(28px, 6vw, 40px)}
    .type{ --c: var(--pop-blue); display:inline-block; padding:.18em .5em; border-radius:999px; font-weight:900; font-size: clamp(26px, 7vw, 44px); color:#fff; background:linear-gradient(135deg, var(--c), #fff0 35%), var(--c); border:3px solid var(--ink); text-shadow:0 2px 0 rgba(0,0,0,.18); transform:rotate(-2deg); box-shadow:var(--shadow-pop) }
    .accent{ color:var(--ink); font-weight:800; margin-left:10px; font-size:clamp(16px, 3.2vw, 20px)}

    .desc{margin:10px 0 8px; font-size:clamp(16px, 2.6vw, 19px)}

    .meta{display:grid; gap:12px; grid-template-columns: 1fr; margin-top:8px}
    .row{display:flex; gap:10px; align-items:center}
    .pill{ display:inline-flex; align-items:center; gap:8px; font-size:15px; padding:10px 14px; border-radius:999px; background:#fff; border:3px solid var(--ink); box-shadow:var(--shadow-pop) }
    .dot{width:12px; height:12px; border:2px solid var(--ink); border-radius:999px; background:var(--pop-yellow)}

    .hint{color:var(--muted); font-size:12px; margin-top:12px}

    /* Responsive grid */
    @media (min-width:620px){ .meta{grid-template-columns: repeat(3, minmax(0,1fr));} }

    /* Confetti */
    .confetti{position:fixed; top:-10px; width:10px; height:14px; opacity:.95; left:50%; pointer-events:none}
    @keyframes fall{to{transform:translateY(110vh) rotate(720deg)}}

    /* color themes */
    .c-daikichi{--c: #00d26a}
    .c-kichi{--c: #06d6a0}
    .c-chukichi{--c: #3a86ff}
    .c-suekichi{--c: #ff6bd6}
    .c-shokichi{--c: #8a5cf6}
    .c-kyo{--c: #ff5a5f}
    .c-daikyo{--c: #e11d48}

    /* SLOT OVERLAY (kept, lever removed) */
    .slot{position:fixed; inset:0; display:grid; place-items:center; backdrop-filter:blur(8px) saturate(1.2);
      background:radial-gradient(800px 400px at 50% -10%, rgba(255,255,255,.9), rgba(255,255,255,.6), rgba(255,255,255,0));
      transition:opacity .25s ease, visibility .25s ease; opacity:1; visibility:visible; z-index:50}
    .slot.hidden{opacity:0; visibility:hidden}
    .slotPanel{border:3px solid var(--ink); border-radius:18px; padding:18px; background:linear-gradient(180deg,#fff,#fff7f1);
      box-shadow:var(--shadow-pop); transform:rotate(-1deg)}
    .reels{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    .reel{width:min(22vw,140px); height:min(22vw,140px); border:3px solid var(--ink); border-radius:16px; background:#111;
      display:grid; place-items:center; color:#fff; font-size: clamp(44px, 11vw, 68px); box-shadow:var(--shadow-pop)}
    .cell{filter:drop-shadow(0 6px 0 rgba(0,0,0,.25))}
    .slotHint{margin-top:10px; text-align:center; color:#555; font-weight:700}

    /* BAD draw shake */
    .shake{animation:shake .55s cubic-bezier(.36,.07,.19,.97) both}
    @keyframes shake{10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-4px)} 40%,60%{transform:translateX(4px)}}

    /* Motion safe */
    @media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" id="card" aria-label="„Åä„Åø„Åè„Åò„Ç´„Éº„Éâ">
      <div class="deco" aria-hidden="true">
        <div class="burst b1"></div>
        <div class="burst b2"></div>
      </div>
      <h1><span class="headline">„Åä„Åø„Åè„Åò POP</span></h1>
      <div class="actions">
        <button class="cta pulse" id="drawBtn" aria-label="„Åä„Åø„Åè„Åò„ÇíÂºï„Åè">
          <span class="icon" aria-hidden="true">üßß</span> ÈÅãÂã¢„ÇíÂºï„Åè
        </button>
        <button class="btn-ghost" id="againBtn" aria-label="„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âºï„Åè" disabled>„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
        <button class="btn-ghost" id="shareBtn" aria-label="ÁµêÊûú„Çí„Ç∑„Çß„Ç¢" disabled>„Ç∑„Çß„Ç¢</button>
      </div>

      <div class="result hidden" id="result" aria-live="polite"></div>
      <p class="hint">‚Äª„Ç®„É≥„Çø„É°Áî®„ÄÇ„ÅÑ„ÅÑÁµêÊûú„ÇÇÊÇ™„ÅÑÁµêÊûú„ÇÇ„ÄÅÁ¨ë„Å£„Å¶Âèó„ÅëÊ≠¢„ÇÅ„Å¶„ÅÑ„Åì„ÅÜÔºÅ</p>
    </section>
  </main>

  <!-- SLOT OVERLAY -->
  <div class="slot hidden" id="slotOverlay" aria-hidden="true">
    <div class="slotPanel">
      <div class="reels">
        <div class="reel"><div class="cell" id="r1">üé∞</div></div>
        <div class="reel"><div class="cell" id="r2">üé∞</div></div>
        <div class="reel"><div class="cell" id="r3">üé∞</div></div>
      </div>
      <div class="slotHint">Âç†„ÅÑ‰∏≠‚Ä¶üé≤</div>
    </div>
  </div>
  <canvas id="fx" style="position:fixed; inset:0; pointer-events:none; z-index:40"></canvas>

  <script>
    // --- Fortune data ---
    const FORTUNES = [
      { key:'daikichi', label:'Â§ßÂêâ', emoji:'üéâ', weight:10, theme:'c-daikichi',
        tips:[
          'ËøΩ„ÅÑÈ¢®„Åå„Éì„É•„É≥ÔºÅÊÄù„ÅÑÂàá„Å£„Åü‰∏ÄÊ≠©„ÅåÊú™Êù•„ÇíÂ§â„Åà„Çã„ÄÇ',
          'Á©ç„ÅøÈáç„Å≠„ÅåËä±Èñã„Åè„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÊ∏©„ÇÅ„ÅüË®àÁîª„ÄÅ„ÅÑ„ÅñËß£Á¶ÅÔºÅ',
          'ÂÖà„Å´‰∏é„Åà„Çã„Å®Èõ™„Å†„Çã„ÅæÂºè„Å´„ÉÅ„É£„É≥„Çπ„ÅåËª¢„Åå„ÇäËæº„ÇÄ„Çà„ÄÇ'
        ]
      },
      { key:'kichi', label:'Âêâ', emoji:'‚ú®', weight:15, theme:'c-kichi',
        tips:[
          'Âü∫Êú¨„Çí‰∏ÅÂØß„Å´„ÄÇÂú∞Âë≥„Åì„ÅùÊúÄÂº∑„É†„Éº„Éñ„ÄÇ',
          'Â∞è„Åï„Å™Â≠¶„Å≥„ÅåÂ§ß„Åç„Å™„Ç∏„É£„É≥„ÉóÂè∞„Å´„ÄÇ',
          '„Äå„ÅÇ„Çä„Åå„Å®„ÅÜ„Äç„ÇíÂ¢ó„ÇÑ„Åô„Åª„Å©„ÄÅÈÅã„ÅÆÂÖ•Âè£„ÅåÂ∫É„Åå„Çã„ÄÇ'
        ]
      },
      { key:'chukichi', label:'‰∏≠Âêâ', emoji:'üåü', weight:25, theme:'c-chukichi',
        tips:[
          'Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ„Çø„Ç§„Éü„É≥„Ç∞Ë¶ãÊ•µ„ÇÅ„Å¶„Çπ„ÉÉ„Å®Ââç„Å∏„ÄÇ',
          'ÊÄ•„Åå„Å∞Âõû„Çå„ÄÇÂØÑ„ÇäÈÅì„ÅåÊúÄÁü≠„Å´„Å™„ÇãÊó•„ÄÇ',
          '‰ø°È†º„ÅÆÂä©Ë®Ä„ÅØ„Éñ„Éº„Çπ„Éà„ÄÇÂèó„ÅëÂèñ„Å£„Å¶Êõ¥„Å´‰º∏„Å≥„Çã„ÄÇ'
        ]
      },
      { key:'shokichi', label:'Â∞èÂêâ', emoji:'üòä', weight:20, theme:'c-shokichi',
        tips:[
          '1„Éü„É™„ÅÆÊîπÂñÑ„ÅåÁ•û„ÄÇ„Åæ„Åö„ÅØÊú∫„Åæ„Çè„Çä„ÇíÊï¥„Åà„Çà„ÅÜ„ÄÇ',
          '‰Ωì„Çí„Åª„Åê„Åõ„Å∞ÂøÉ„ÇÇËªΩ„ÅÑ„ÄÇ„Çπ„Éà„É¨„ÉÉ„ÉÅ„Åß„É™„Éï„É¨„ÉÉ„Ç∑„É•„ÄÇ',
          'Á¨ëÈ°î„ÅÆÊå®Êã∂„Åß„ÅîÁ∏Å„Åå„Éù„É≥„ÉÉ„Å®„Å§„Å™„Åå„Çã„ÄÇ'
        ]
      },
      { key:'suekichi', label:'Êú´Âêâ', emoji:'üå±', weight:15, theme:'c-suekichi',
        tips:[
          'ËäΩ„ÅåÂá∫„Çã„Å´„ÅØÊôÇÈñì„ÅåË¶Å„Çã„ÄÇÁÑ¶„Çâ„Åö„Ç≥„ÉÑ„Ç≥„ÉÑ„ÄÇ',
          '„Ç¢„Ç§„Éá„Ç¢„ÅØ„É°„É¢„ÅßÁÜüÊàê„ÄÇ‰ªäÊó•„ÅØÊ∏©Â≠ò„ÅåÊ≠£Ëß£„ÄÇ',
          'ÈÅ†Âõû„Çä„ÅØÊ†ÑÈ§ä„ÄÇÁµåÈ®ì„ÇíÁ©ç„Çì„ÅßÂº∑„Åè„Å™„Çã„ÄÇ'
        ]
      },
      { key:'kyo', label:'Âá∂', emoji:'üåßÔ∏è', weight:12, theme:'c-kyo',
        tips:[
          'ÂÆà„Çä„ÅÆ‰∏ÄÊâã„ÄÇÁÑ°ÁêÜ„Å™ÂãùË≤†„ÅØ„Åó„Å™„ÅÑÊó•„ÄÇ',
          'Áù°Áú†ÔºÜÈ£ü‰∫ã„Çí‰∏ÅÂØß„Å´Êï¥„Åà„Å¶Ë∂≥Â†¥„Å•„Åè„Çä„ÄÇ',
          '„Å≤„Å®ÂëºÂê∏„Åä„ÅÑ„Å¶Áõ∏ÊâãÁõÆÁ∑ö„ÄÇË°ùÁ™Å„ÅØ„Åµ„Çè„Å£„Å®ÂõûÈÅø„ÄÇ'
        ]
      },
      { key:'daikyo', label:'Â§ßÂá∂', emoji:'‚õàÔ∏è', weight:3, theme:'c-daikyo',
        tips:[
          'Èùô„Åã„Å™ÂæπÂ∫ïÊï¥ÂÇô„Éá„Éº„ÄÇÂãï„Åã„Å™„ÅÑÂãáÊ∞ó„ÅåÂêâ„ÄÇ',
          '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÊéÉÈô§„ÉªÁâá‰ªò„Åë„ÅßÂÆâÂøÉÂ∫¶MAX„ÄÇ',
          '„ÅÇ„Å£„Åü„Åã„ÅÑ‰∏ÄÊùØ„ÅßÂøÉ„ÇíÊ∏©„ÇÅ„Å¶„ÄÇÊòéÊó•„ÅØÊòéÊó•„ÅÆÈ¢®„ÅåÂêπ„ÅèÔºÅ'
        ]
      },
    ];

    const LUCKY_ITEMS = ['‰∏áÂπ¥Á≠Ü','Á∑ëËå∂','„Çπ„Éà„É¨„ÉÉ„ÉÅ','„Éé„Éº„Éà','„Çπ„Éû„Éõ„ÅÆÂÜôÁúüÊï¥ÁêÜ','Êï£Ê≠©','„Éè„É≥„Ç´„ÉÅ','„Ç§„É§„Éõ„É≥','ÊâãÂ∏≥','Êú¨'];
    const LUCKY_COLORS = ['Ëµ§','Èùí','Á∑ë','ÈªÑËâ≤','Á¥´','ÁôΩ','Èªí','„Ç™„É¨„É≥„Ç∏','Ê°ÉËâ≤','Ê∞¥Ëâ≤'];
    const ACTIONS = ['10ÂàÜ„Å†„ÅëÁâá‰ªò„Åë','„Äå„ÅÇ„Çä„Åå„Å®„ÅÜ„Äç„Çí3Âõû‰ºù„Åà„Çã','ËÉåÁ≠ã„Çí‰º∏„Å∞„Åô','Ê∑±ÂëºÂê∏„Çí5Âõû','‰ªäÊó•„ÅØÊó©ÂØù','Á¨ëÈ°î„ÅßÊå®Êã∂','Â∞è„Åï„Å™ÂØÑ‰ªò','ÂßøÂã¢„ÇíÊÑèË≠ò','Ê∏©„Åã„ÅÑÈ£≤„ÅøÁâ©','Áü≠„ÅÑ„É°„É¢„ÇíÊõ∏„Åè'];

    const ICONS = { '‰∏áÂπ¥Á≠Ü':'‚úíÔ∏è','Á∑ëËå∂':'üçµ','„Çπ„Éà„É¨„ÉÉ„ÉÅ':'üßò','„Éé„Éº„Éà':'üìí','„Çπ„Éû„Éõ„ÅÆÂÜôÁúüÊï¥ÁêÜ':'üßπ','Êï£Ê≠©':'üö∂','„Éè„É≥„Ç´„ÉÅ':'üßª','„Ç§„É§„Éõ„É≥':'üéß','ÊâãÂ∏≥':'üìî','Êú¨':'üìö' };
    const SLOT_EMOJIS = ['üçÄ','‚≠êÔ∏è','üíé','üéà','üîî','üêâ','üßß','ü™Ñ','üéä','‚ú®'];

    const drawBtn = document.getElementById('drawBtn');
    const againBtn = document.getElementById('againBtn');
    const shareBtn = document.getElementById('shareBtn');
    const result = document.getElementById('result');
    const card = document.getElementById('card');

    const slotOverlay = document.getElementById('slotOverlay');
    const r1 = document.getElementById('r1');
    const r2 = document.getElementById('r2');
    const r3 = document.getElementById('r3');

    const fxCanvas = document.getElementById('fx');
    const ctx = fxCanvas.getContext('2d');

    // utils
    function weightedPick(items){
      const total = items.reduce((s,i)=>s+i.weight,0);
      let r = Math.random()*total;
      for(const i of items){ r -= i.weight; if(r <= 0) return i; }
      return items[items.length-1];
    }
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];

    // Audio (WebAudio tiny SE)
    let audioCtx;
    function playSE(kind='click'){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const now = audioCtx.currentTime; g.gain.setValueAtTime(.0001, now);
        if(kind==='spin'){ o.type='sawtooth'; o.frequency.setValueAtTime(220, now); g.gain.exponentialRampToValueAtTime(.2, now+.02); g.gain.exponentialRampToValueAtTime(.05, now+.3); }
        else if(kind==='stop'){ o.type='square'; o.frequency.setValueAtTime(660, now); g.gain.setValueAtTime(.15, now); g.gain.exponentialRampToValueAtTime(.0001, now+.15); }
        else if(kind==='win'){ o.type='triangle'; o.frequency.setValueAtTime(523, now); o.frequency.exponentialRampToValueAtTime(880, now+.25); g.gain.setValueAtTime(.18, now); g.gain.exponentialRampToValueAtTime(.0001, now+.3); }
        else if(kind==='lose'){ o.type='sine'; o.frequency.setValueAtTime(196, now); o.frequency.exponentialRampToValueAtTime(98, now+.25); g.gain.setValueAtTime(.18, now); g.gain.exponentialRampToValueAtTime(.0001, now+.35); }
        else { o.type='triangle'; o.frequency.setValueAtTime(440, now); g.gain.setValueAtTime(.12, now); g.gain.exponentialRampToValueAtTime(.0001, now+.12); }
        o.start(); o.stop(now+.4);
      }catch(e){ /* ignore */ }
    }

    // SLOT sequence (lever removed)
    function slotStart(){
      slotOverlay.classList.remove('hidden');
      const timers = [r1,r2,r3].map((cell, idx)=>{
        let i=0; return setInterval(()=>{ cell.textContent = SLOT_EMOJIS[(i++)%SLOT_EMOJIS.length]; }, 60 + idx*30);
      });
      playSE('spin');
      return timers;
    }
    function slotStop(timers){
      return new Promise(res=>{
        timers.forEach((t, i)=> setTimeout(()=>{ clearInterval(t); playSE('stop'); if(i===timers.length-1){ setTimeout(()=>{ slotOverlay.classList.add('hidden'); res(); }, 220); } }, 650 + i*220));
      });
    }

    // Fireworks
    let particles=[]; let rafId=null;
    function resizeCanvas(){ fxCanvas.width = innerWidth; fxCanvas.height = innerHeight; }
    addEventListener('resize', resizeCanvas, {passive:true}); resizeCanvas();

    function fireworkBurst(x, y, color){
      for(let i=0;i<80;i++){
        const a = Math.random()*Math.PI*2; const s = Math.random()*4+2;
        particles.push({x, y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:60, color});
      }
      if(!rafId) rafId = requestAnimationFrame(loop);
    }
    function loop(){
      ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);
      for(const p of particles){
        ctx.fillStyle = p.color; ctx.globalCompositeOperation = 'lighter';
        ctx.fillRect(p.x, p.y, 3, 3);
        p.x += p.vx; p.y += p.vy; p.vy += .05; p.life--; 
      }
      particles = particles.filter(p=>p.life>0);
      if(particles.length){ rafId = requestAnimationFrame(loop); } else { cancelAnimationFrame(rafId); rafId=null; }
    }

    function fireworksShow(){
      const colors = ['#ff2d55','#ffd166','#3a86ff','#06d6a0','#8a5cf6'];
      fireworkBurst(innerWidth*.25, innerHeight*.35, choice(colors));
      setTimeout(()=>fireworkBurst(innerWidth*.6, innerHeight*.28, choice(colors)), 180);
      setTimeout(()=>fireworkBurst(innerWidth*.45, innerHeight*.5, choice(colors)), 320);
      playSE('win');
    }

    // Confetti
    function confettiBurst(){
      const N = 120; const colors = ['#ff2d55','#ffd166','#3a86ff','#06d6a0','#8a5cf6','#111827'];
      for(let i=0;i<N;i++){
        const d = document.createElement('div');
        d.className='confetti';
        const x = Math.random()*100; // vw
        const rot = Math.random()*360;
        const dur = 2.2 + Math.random()*1.8;
        const size = 8 + Math.random()*10;
        d.style.left = x+'vw';
        d.style.width = size+'px'; d.style.height = size+'px';
        d.style.background = colors[Math.floor(Math.random()*colors.length)];
        d.style.transform = `translateY(-10px) rotate(${rot}deg)`;
        d.style.animation = `fall ${dur}s linear forwards`;
        const shape = Math.random();
        if(shape < .33) d.style.borderRadius = '999px';
        else if(shape < .66) d.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
        else d.style.clipPath = 'polygon(50% 0, 0 100%, 100% 100%)';
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), dur*1000);
      }
    }

    // DRAW flow
    let lastShareText = '';
    const motionOK = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let first = true;

    async function runDraw(){
      drawBtn.classList.remove('pulse');
      card.classList.add('halo');
      if(motionOK){
        const timers = slotStart();
        await slotStop(timers);
      }
      showFortune();
      againBtn.disabled = false;
      shareBtn.disabled = false;
      if(first){ drawBtn.focus(); first=false; }
    }

    function showFortune(){
      const f = weightedPick(FORTUNES);
      const tip = choice(f.tips);
      const item = choice(LUCKY_ITEMS);
      const color = choice(LUCKY_COLORS);
      const action = choice(ACTIONS);

      result.classList.remove('hidden');
      result.innerHTML = `
        <div class="fortune ${f.theme}">
          <span class="emoji" aria-hidden="true">${f.emoji}</span>
          <div>
            <span class="type">${f.label}</span>
            <span class="accent">‰ªäÊó•„ÅÆÈÅãÂã¢</span>
          </div>
        </div>
        <p class="desc">${tip}</p>
        <div class="meta">
          <div class="row"><span class="pill">${ICONS[item]||'üéØ'} „É©„ÉÉ„Ç≠„Éº„Ç¢„Ç§„ÉÜ„É†Ôºö${item}</span></div>
          <div class="row"><span class="pill"><span class="dot" style="background:${cssColor(color)}"></span> „É©„ÉÉ„Ç≠„Éº„Ç´„É©„ÉºÔºö${color}</span></div>
          <div class="row"><span class="pill">‚úÖ ÈñãÈÅã„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºö${action}</span></div>
        </div>`;

      lastShareText = `„Äê„Åä„Åø„Åè„Åò„Äë${f.label} ${f.emoji}

${tip}
„É©„ÉÉ„Ç≠„Éº„Ç¢„Ç§„ÉÜ„É†Ôºö${item}Ôºè„Ç´„É©„ÉºÔºö${color}ÔºèË°åÂãïÔºö${action}`;

      if(['daikichi','kichi','chukichi'].includes(f.key)){
        confettiBurst(); if(f.key==='daikichi') fireworksShow();
      } else {
        card.classList.add('shake'); playSE('lose'); setTimeout(()=>card.classList.remove('shake'), 600);
      }
      if(navigator.vibrate) navigator.vibrate(14);
    }

    function cssColor(jp){
      const map = { 'Ëµ§':'#ef4444','Èùí':'#3b82f6','Á∑ë':'#10b981','ÈªÑËâ≤':'#f59e0b','Á¥´':'#8b5cf6','ÁôΩ':'#ffffff','Èªí':'#111827','„Ç™„É¨„É≥„Ç∏':'#fb923c','Ê°ÉËâ≤':'#f472b6','Ê∞¥Ëâ≤':'#38bdf8' };
      return map[jp] || '#ffd166';
    }

    drawBtn.addEventListener('click', runDraw);
    againBtn.addEventListener('click', runDraw);

    shareBtn.addEventListener('click', async ()=>{
      const text = lastShareText || '„Åä„Åø„Åè„Åò„Åß‰ªäÊó•„ÅÆÈÅãÂã¢„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºÅ';
      const data = { title:'„Åä„Åø„Åè„Åò', text, url: location.href };
      try{
        if(navigator.share){ await navigator.share(data); }
        else{ await navigator.clipboard.writeText(text + '\n' + location.href); alert('ÂÖ±Êúâ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ'); }
      }catch(e){ /* user cancelled */ }
    });

    // 3D tilt for card (subtle, motion-safe)
    if(motionOK){
      const strength = 8;
      card.addEventListener('pointermove', (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left)/r.width - .5;
        const y = (e.clientY - r.top)/r.height - .5;
        card.style.transform = `rotateX(${(-y*strength).toFixed(2)}deg) rotateY(${(x*strength).toFixed(2)}deg)`;
      });
      card.addEventListener('pointerleave', ()=>{ card.style.transform = 'rotate(0deg)'; });
    }

    // keyboard accessibility
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){ if(document.activeElement === document.body) runDraw(); }
    });
  </script>
</body>
</html>
